name: Quick GH-pages push & token test
on: workflow_dispatch

permissions: 
  contents: read
  pages: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Show which token will be used
        run: |
          echo "Using secret GH_PAGES_TOKEN present? ${GH_PAGES_TOKEN:+yes}"
        env:
          GH_PAGES_TOKEN: ${{ secrets.GH_PAGES_TOKEN }}

      - name: Verify token via REST API (shows scopes & repo permissions)
        env:
          GH_PAGES_TOKEN: ${{ secrets.GH_PAGES_TOKEN }}
        run: |
          set -eux
          # show who the token is (user) and X-OAuth-Scopes header
          echo "=== GET https://api.github.com/user (identity & scopes) ==="
          curl -i -H "Authorization: token $GH_PAGES_TOKEN" https://api.github.com/user | sed -n '1,120p'
          echo
          echo "=== Repo info (permissions field) ==="
          curl -s -H "Authorization: token $GH_PAGES_TOKEN" "https://api.github.com/repos/linux-03/ASC_ODE_BLA" | jq .permissions || true

      - name: Attempt a small git push using the token (non-destructive test)
        env:
          GH_PAGES_TOKEN: ${{ secrets.GH_PAGES_TOKEN }}
        run: |
          set -eux
          TMPDIR=$(mktemp -d)
          mkdir -p "$TMPDIR/test-site"
          echo "ci test $(date -u)" > "$TMPDIR/test-site/index.html"
          cd "$TMPDIR"
          git init
          git config user.name "gh-actions-test"
          git config user.email "actions@example.com"
          git add -A
          git commit -m "test gh-pages push"
          # push to gh-pages (force) using PAT in HTTPS URL; replace with your repo path
          git push --force "https://${GH_PAGES_TOKEN}@github.com/linux-03/ASC_ODE_BLA.git" HEAD:gh-pages || true
          echo "git push exit code: $?"
