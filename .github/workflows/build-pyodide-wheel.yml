name: Build Pyodide wheel, build Jupyter-Lite site, deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout repository (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0

      - name: Verify submodule files present
        run: |
          echo "ls bla/src:"
          ls -la bla/src || true
          echo "check for vector.h and matrix.h"
          test -f bla/src/vector.h && echo "vector.h present" || echo "vector.h MISSING"
          test -f bla/src/matrix.h && echo "matrix.h present" || echo "matrix.h MISSING"
        shell: bash

      - name: Install system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget build-essential cmake ninja-build python3-venv nodejs unzip
        shell: bash

      - name: Create Python venv and install Python build tools
        run: |
          set -eux
          python3 -m venv ~/pyodide-venv
          source ~/pyodide-venv/bin/activate
          pip install --upgrade pip
          # essential build deps for scikit-build-core, pybind11 etc.
          pip install wheel scikit-build-core cmake pybind11 ninja
          # pyodide build tool (version must match your expected pyodide version)
          pip install pyodide-build==0.26.1
          # jupyter-lite core (to run jupyter lite build) and pyodide kernel helper
          pip install jupyterlite-core jupyterlite-pyodide-kernel
          pip install jupyter-server jupyterlab_server libarchive-c
        shell: bash

      - name: Install Emscripten SDK (emsdk)
        run: |
          set -eux
          # clone emsdk into runner home
          git clone https://github.com/emscripten-core/emsdk.git ~/emsdk
          cd ~/emsdk
          ./emsdk install 3.1.58
          ./emsdk activate 3.1.58
        shell: bash

      - name: Source emsdk, build Pyodide wheel from project root
        # use a login shell so 'source' works and PATH is sane
        shell: bash -l {0}
        run: |
          set -eux

          echo "GITHUB_WORKSPACE=${GITHUB_WORKSPACE:-/github/workspace}"
          # source emsdk from inside its directory (emsdk recommends this)
          cd ~/emsdk
          echo "Sourcing emsdk from $(pwd)"
          source ./emsdk_env.sh

          # go back to repo root (where your pyproject.toml should be)
          cd "${GITHUB_WORKSPACE:-/github/workspace}"
          echo "Building from project dir: $(pwd)"
          ls -la | sed -n '1,200p'

          # Activate pyodide venv
          source ~/pyodide-venv/bin/activate
          echo "python: $(which python)  pyodide: $(which pyodide || true)"

          # Prevent pybind11 / CMake from trying to validate host Python vs cross-compiler
          # This avoids the "Python is 64-bit, chosen compiler is 32-bit" error during cross-build.
          export CMAKE_ARGS="-DPYBIND11_FINDPYTHON=OFF -DPYBIND11_FINDPYTHON_EXECUTABLE:STRING=$(which python) -DCMAKE_POLICY_VERSION_MINIMUM=3.5 -DCMAKE_POLICY_VERSION=3.18"
          echo "CMAKE_ARGS=$CMAKE_ARGS"

          # Build the Pyodide wheel (may download xbuildenv; can be slow first time)
          pyodide build

          # show generated artifacts
          ls -la dist || true

      - name: Prepare Jupyter-Lite site and copy pyodide artifacts
        shell: bash
        run: |
          set -eux
          # Where to put the assembled site (temp dir)
          SITE_TMP=/tmp/rigid_body_interactive
          rm -rf "${SITE_TMP}"
          git clone https://github.com/triadtitans/rigid_body_interactive.git "${SITE_TMP}"

          # Ensure static pyodide dir exists and copy our pyodide wheel artifacts in
          mkdir -p "${SITE_TMP}/dist/static/pyodide"
          # copy the pyodide-built files (adjust path if your build emits elsewhere)
          cp -r ./dist/* "${SITE_TMP}/dist/static/pyodide/" || true

          # list what we copied for debugging
          echo "Copied files:"
          ls -la "${SITE_TMP}/dist/static/pyodide" || true

      - name: Install jupyterlite pyodide kernel integration & helpers
        shell: bash
        run: |
          set -eux
          source ~/pyodide-venv/bin/activate

          # install the integration that jupyter lite knows how to bundle
          pip install --upgrade pip setuptools wheel
          pip install jupyterlite-pyodide-kernel jupyter-server jupyterlab_server libarchive-c || true

          # install piplite from GitHub (robust fallback if PyPI doesn't provide a wheel on CI)
          pip install git+https://github.com/pyodide/piplite.git

          # quick sanity: list these packages and versions
          pip show jupyterlite-pyodide-kernel piplite jupyter-server jupyterlab_server || true

      - name: Build Jupyter-Lite site (bundles pyodide)
        shell: bash -l {0}
        run: |
          set -eux
          source ~/pyodide-venv/bin/activate

          SITE_TMP=/tmp/rigid_body_interactive
          cd "${SITE_TMP}"
          # The --pyodide option can point to a tarball URL (or omit if included)
          jupyter lite build --pyodide https://ngsolve.org/files/pyodide-0.26.0/ngsolve_pyodide.tar.bz2
          ls -la dist || true

      - name: Deploy site to GitHub Pages (gh-pages)
        uses: peaceiris/actions-gh-pages@v4
        with:
          personal_token: ${{ secrets.GH_PAGES_TOKEN }}
          publish_dir: /tmp/rigid_body_interactive/dist
          publish_branch: gh-pages
          force_orphan: true
          keep_files: false
          enable_jekyll: false
          exclude_assets: .github
