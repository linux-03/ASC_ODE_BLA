name: Build Pyodide wheel, build Jupyter-Lite site, deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget build-essential cmake ninja-build python3-venv nodejs unzip
        shell: bash

      - name: Create Python venv and install build tooling
        run: |
          set -eux
          python3 -m venv ~/pyodide-venv
          source ~/pyodide-venv/bin/activate
          pip install --upgrade pip
          pip install wheel scikit-build-core cmake pybind11 ninja
          pip install pyodide-build==0.26.1
          pip install jupyterlite-core jupyterlite-pyodide-kernel
        shell: bash

      - name: Install Emscripten SDK (emsdk)
        run: |
          set -eux
          git clone https://github.com/emscripten-core/emsdk.git ~/emsdk
          cd ~/emsdk
          ./emsdk install 3.1.58
          ./emsdk activate 3.1.58
        shell: bash

      - name: Patch CMakeLists.txt to disable PYBIND11_FINDPYTHON for Emscripten cross-builds
        # This inserts a tiny guard right after cmake_minimum_required(...) so pybind11 won't do host-Python ABI checks
        run: |
          set -eux
          CMK="CMakeLists.txt"
          if [ -f "$CMK" ]; then
            echo "Patching $CMK (inserting PYBIND11_FINDPYTHON OFF guard)..."
            cp "$CMK" "${CMK}.ci.bak"
            # Insert after the cmake_minimum_required(...) line.
            # If cmake_minimum_required exists, put the guard after it; otherwise prepend.
            if grep -q -E "cmake_minimum_required" "$CMK"; then
              awk '{
                print;
                if(!done && match($0,/cmake_minimum_required/)) {
                  print "";
                  print "# --- CI-inserted: disable pybind11 Python probing when cross-compiling to Emscripten ---";
                  print "if(CMAKE_SYSTEM_NAME STREQUAL \"Emscripten\" OR CMAKE_CROSSCOMPILING)";
                  print "  message(STATUS \"CI: cross-compiling -> disable PYBIND11_FINDPYTHON\")";
                  print "  set(PYBIND11_FINDPYTHON OFF CACHE BOOL \"CI: do not find host python when cross-compiling\")";
                  print "endif()";
                  print "# --- end CI insertion ---";
                  done=1;
                }
              } END { if(!done) { print \"# --- CI-inserted fallback: disable pybind11 Python probing\"; print \"if(CMAKE_SYSTEM_NAME STREQUAL \\\"Emscripten\\\" OR CMAKE_CROSSCOMPILING)\"; print \"  set(PYBIND11_FINDPYTHON OFF CACHE BOOL \\\"CI: do not find host python when cross-compiling\\\")\"; print \"endif()\" } }' "${CMK}.ci.bak" > "$CMK"
            else
              # no cmake_minimum_required found: prepend guard
              cat > "$CMK.tmp" <<'EOF'
              # --- CI-inserted guard: disable pybind11 python probing for cross-compiles ---
              if(CMAKE_SYSTEM_NAME STREQUAL "Emscripten" OR CMAKE_CROSSCOMPILING)
                message(STATUS "CI: cross-compiling -> disable PYBIND11_FINDPYTHON")
                set(PYBIND11_FINDPYTHON OFF CACHE BOOL "CI: do not find host python when cross-compiling")
              endif()
              # --- end guard ---
              EOF
              cat "$CMK" >> "$CMK.tmp"
              mv "$CMK.tmp" "$CMK"
            fi
            echo "Patch applied. Showing head of patched file:"
            sed -n '1,60p' "$CMK" || true
          else
            echo "No CMakeLists.txt found; skipping patch."
          fi
        shell: bash

      - name: Source emsdk, run pyodide build from repo root
        shell: bash -l {0}
        run: |
          set -eux
          # Source emsdk from inside its directory (recommended)
          cd ~/emsdk
          source ./emsdk_env.sh

          # Return to repo root (adjust if package is in a subdir)
          cd "${GITHUB_WORKSPACE:-/github/workspace}"

          # Activate venv
          source ~/pyodide-venv/bin/activate

          # Help CMake further by disabling PYBIND11_FINDPYTHON again via CMAKE_ARGS
          export CMAKE_ARGS="-DPYBIND11_FINDPYTHON=OFF -DPYBIND11_FINDPYTHON_EXECUTABLE:STRING=$(which python)"
          echo "CMAKE_ARGS=$CMAKE_ARGS"

          # Ensure pyodide-build is present
          python -m pip show pyodide-build || python -m pip install pyodide-build==0.26.1

          # Build Pyodide wheel (first run downloads xbuildenv and can take several minutes)
          pyodide build

          # List the produced artifacts
          ls -la dist || true
        env:
          PATH: ${{ runner.tool_cache }}:/usr/local/bin:$PATH

      - name: Prepare Jupyter-Lite site and copy pyodide artifacts
        shell: bash
        run: |
          set -eux
          SITE_TMP=/tmp/rigid_body_interactive
          rm -rf "${SITE_TMP}"
          git clone https://github.com/triadtitans/rigid_body_interactive.git "${SITE_TMP}"

          mkdir -p "${SITE_TMP}/dist/static/pyodide"
          cp -r ./dist/* "${SITE_TMP}/dist/static/pyodide/" || true

          echo "Copied files:"
          ls -la "${SITE_TMP}/dist/static/pyodide" || true

      - name: Build Jupyter-Lite site (bundles pyodide)
        shell: bash -l {0}
        run: |
          set -eux
          source ~/pyodide-venv/bin/activate
          SITE_TMP=/tmp/rigid_body_interactive
          cd "${SITE_TMP}"
          jupyter lite build --pyodide https://ngsolve.org/files/pyodide-0.26.0/ngsolve_pyodide.tar.bz2
          ls -la dist || true

      - name: Deploy site to GitHub Pages (gh-pages)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: /tmp/rigid_body_interactive/dist
